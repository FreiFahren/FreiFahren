set dotenv-load
set positional-arguments

build platform profile:
  #!/bin/bash
  if [[ -n "$(git status --porcelain)" ]]; then
    echo "Error: You have uncommitted changes. Please commit or stash your changes before running this script."
    exit 1
  fi

  if git describe --tags --exact-match &> /dev/null | grep -q '{{platform}}-release/'; then
    echo "Error: Current commit is already tagged. Create a new commit."
    exit 1
  fi

  mkdir -p build/{{platform}}

  version_codes=()
  for tag in $(git tag --list '{{platform}}-release/*'); do
    version=$(echo $tag | sed 's/{{platform}}-release\///g')
    version_codes+=($version)
  done
  current_version=$(($(printf '%d\n' "${version_codes[@]}" | sort -n | tail -1) + 1))

  echo "New version code: $current_version"

  output_path="build/{{platform}}/{{profile}}-$current_version"

  VERSION_CODE=$current_version eas build --platform {{platform}} --local --profile {{profile}} --output $output_path --non-interactive

  git tag "{{platform}}-release/$current_version"

  echo "Successfully built version $current_version"

submit platform profile path:
  eas submit --platform {{platform}} --profile {{profile}} --path {{path}}
