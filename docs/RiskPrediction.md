# Documentation for the Risk Prediction of the Line Segments

## Overview:
This document provides a detailed overview of the architecture and data flow for the risk prediction system used to highlight segments of public transport lines, indicating the increased likelihood of ticket inspector checks.


## Architecture components:
### Frontend:
- **Displaying the inital lines**: The frontend displays public transport lines split into segments with the base colors. While loading these lines, it concurrently sends a request to `/getSegmentColors` to fetch the risk data.

### Backend:
- **Creating Highlighted Segments**: When the backend receives a new report of a ticket inspection, it runs an R-script to generate the risk data for each segment. Before running the R-script it will get the recent ticket inspectors and save them to a json that can be used by the riskmodel as an input. The R-script generates a JSON document with the risk data for each segment, for example:
```Json
{
    "S1-1": "#FF0000",
    "S1-2": "#00FF00",
    ...
}
```

- **Handling requests to `/getSegmentColors`**: When a request is made to this endpoint, the backend reads the JSON document generated by the R-script and sends it back to the frontend. It uses if-modified-since headers to avoid sending the same data multiple times to the frontend.


## Risk Prediction Algorithm:
A stochastic risk model estimates the risk of running into an inspection; aggregations of marginal probability distributions on a line and neighbouring lines are computed conditional on reports and the underlying network structure. Each report adds a marginal risk along the graph, letting it diffuse through the network spatially and temporally. S-curve-like exponential sigmoid functions represent a temporal decrease in risk as a report ages, and discrete beta-binomial distributions represent the spatial extent of increased risk of exposure.

- each report is matched against the underlying network (directed graph with a default direction for each line)
- when available, a report's direction is computed according to the directed graph
- for each report, local marginal base-line risks are computed, taking into account the age of the report, as well as, when available the reported station and direction
  - directed risk: risk that will later be diffused only in the reported direction
  - bi-directed risk: risk that will later be diffused in both directions
  - line-specific risk: risk that will later be diffused onto the whole line
- for each segment, base-line risks are aggregated and in the case of directed, bi-directed, or line-specific risks diffused to the respective neighbour segments
- neighbour lines on the same routes (within the same sub-network, i.e., S-Bahn or U-Bahn) spill over their risk to the other lines
- risk levels are projected to a discrete 4-level color scale